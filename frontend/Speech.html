<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Speech Emotion Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Sidebar collapse */
    .collapsed .sidebar-text { display: none; }
    .collapsed .sidebar { width: 4rem; }
    .sidebar { width: 16rem; transition: width 0.3s ease; }

    /* Gradients & colors */
    .bg-gradient-card {
      background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95));
    }
    .bg-gradient-primary {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
    }
    .hover\:shadow-glow:hover {
      box-shadow: 0 0 20px rgba(59,130,246,0.6);
    }
    .smooth-transition { transition: all 0.3s ease; }
    .text-success { color: #22c55e; }
    .border-success { border-color: #22c55e; }
    .text-warning { color: #f59e0b; }
    .border-warning { border-color: #f59e0b; }
    .border-muted-foreground { border-color: #6b7280; }
    .text-muted-foreground { color: #9ca3af; }
    .bg-accent { background-color: #06b6d4; }
    .text-accent { color: #06b6d4; }
    .bg-destructive { background-color: #ef4444; }
    .text-destructive { color: #ef4444; }
  </style>
</head>
<body class="flex min-h-screen bg-gray-950 text-gray-100">

  <div id="sidebar" class="sidebar bg-gray-800 border-r border-gray-700 flex flex-col">
    <div class="border-b border-gray-700 p-4 flex items-center justify-between">
      <a href="landing.html" class="flex items-center space-x-2">
        <i data-lucide="bar-chart-4" class="h-8 w-8 text-blue-400"></i>
        <div class="sidebar-text">
          <h2 class="text-lg font-bold text-blue-400">Mood Metrics</h2>
          <p class="text-xs text-gray-400">Emotion Intelligence</p>
        </div>
      </a>
      <button id="toggleSidebar" class="p-2 rounded-md border border-gray-600 hover:bg-gray-700">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
      </button>
    </div>

    <div class="flex-1 px-2 py-4 overflow-y-auto">
      <p class="text-xs font-semibold text-gray-400 mb-2 sidebar-text">Main Navigation</p>
      <ul class="space-y-1">
        <li><a href="dashboard.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="layout-dashboard" class="h-4 w-4 mr-2"></i><span class="sidebar-text">Dashboard</span></a></li>
        <li><a href="Text.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="file-text" class="h-4 w-4 mr-2"></i><span class="sidebar-text">Text Analysis</span></a></li>
        <li><a href="Speech.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700 bg-gray-700"><i data-lucide="mic" class="h-4 w-4 mr-2 text-blue-400"></i><span class="sidebar-text">Speech Analysis</span></a></li>
        <li><a href="Video_new.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="video" class="h-4 w-4 mr-2"></i><span class="sidebar-text">Video Analysis</span></a></li>
        <li><a href="testing bot/templates/chatbot.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="message-square" class="h-4 w-4 mr-2"></i><span class="sidebar-text">AI Chatbot</span></a></li>
        <li><a href="analytics.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i><span class="sidebar-text">Analytics</span></a></li>
      </ul>
      <p class="text-xs font-semibold text-gray-400 mt-6 mb-2 sidebar-text">Account</p>
      <ul class="space-y-1">
        <li><a href="settings.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="settings" class="h-4 w-4 mr-2"></i><span class="sidebar-text">Settings</span></a></li>
        <li><a href="profile.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700"><i data-lucide="user" class="h-4 w-4 mr-2"></i><span class="sidebar-text">Profile</span></a></li>
      </ul>
    </div>

    <div class="border-t border-gray-700 p-4">
      <button class="flex items-center w-full px-3 py-2 rounded hover:bg-red-900 text-red-400">
        <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
        <span class="sidebar-text">Sign Out</span>
      </button>
    </div>
  </div>

  <main class="flex-1 p-6 space-y-6">
    <h1 class="text-3xl font-bold flex items-center">
      <i data-lucide="mic" class="w-8 h-8 mr-3 text-blue-400"></i>
      Speech Emotion Analysis
    </h1>
    <p class="text-muted-foreground">Record or upload audio for emotion analysis.</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-gradient-card border border-gray-800 rounded-xl p-6 space-y-6 hover:shadow-glow smooth-transition">
        <h2 class="text-xl font-semibold">Audio Recording</h2>
        <div class="text-center py-6">
          <div id="micCircle" class="w-32 h-32 rounded-full mx-auto mb-6 flex items-center justify-center bg-blue-500/20">
            <i data-lucide="mic" class="w-16 h-16 text-blue-400"></i>
          </div>
          <button id="recordBtn" class="px-6 py-2 rounded-lg bg-gradient-primary hover:shadow-glow text-white smooth-transition">Start Recording</button>
          <p id="recordingStatus" class="text-sm text-gray-400 mt-2 hidden">Recording... Speak clearly</p>
        </div>

        <div class="text-center">
          <input type="file" id="uploadInput" accept="audio/*" class="hidden"/>
          <button id="uploadBtn" class="px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700 flex items-center mx-auto">
            <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Upload Audio
          </button>
        </div>

        <div id="audioPreview" class="hidden p-4 bg-gray-700/50 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <span id="audioName" class="text-sm font-medium">recording.wav</span>
            <span id="audioDuration" class="text-sm text-gray-400">0:00</span>
          </div>
          <audio id="audioPlayer" controls class="w-full"></audio>
          <button id="analyzeBtn" class="mt-3 w-full px-4 py-2 rounded-lg bg-gradient-primary hover:shadow-glow text-white smooth-transition">
            Analyze Speech
          </button>
        </div>
      </div>

      <div id="resultsDiv" class="bg-gradient-card border border-gray-800 rounded-xl p-6 hover:shadow-glow smooth-transition">
        <h2 class="text-xl font-semibold">Speech Analysis Results</h2>
        <p class="text-muted-foreground mt-4">Results will appear here after analysis.</p>
      </div>

    </div>
  </main>

<script>
  lucide.createIcons();

  // Sidebar toggle
  const toggleBtn = document.getElementById("toggleSidebar");
  const sidebar = document.getElementById("sidebar");
  toggleBtn.addEventListener("click", () => sidebar.classList.toggle("collapsed"));

  // Audio recording elements
  const recordBtn = document.getElementById("recordBtn");
  const micCircle = document.getElementById("micCircle");
  const recordingStatus = document.getElementById("recordingStatus");
  const audioPreview = document.getElementById("audioPreview");
  const audioName = document.getElementById("audioName");
  const audioDuration = document.getElementById("audioDuration");
  const audioPlayer = document.getElementById("audioPlayer");
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadInput = document.getElementById("uploadInput");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const resultsDiv = document.getElementById("resultsDiv");

  let mediaRecorder, audioChunks = [], audioBlob;
  let isRecording = false;
  let emotionChart = null;

  // ---------- Recording ----------
  recordBtn.addEventListener("click", async () => {
    if (!isRecording) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;
        audioPreview.classList.remove("hidden");
        audioName.textContent = "recording.wav";

        const tempAudio = new Audio(audioUrl);
        tempAudio.onloadedmetadata = () => {
          const mins = Math.floor(tempAudio.duration / 60);
          const secs = Math.floor(tempAudio.duration % 60);
          audioDuration.textContent = `${mins}:${secs < 10 ? "0"+secs : secs}`;
        };
      };

      micCircle.classList.add("animate-pulse");
      recordingStatus.classList.remove("hidden");
      recordBtn.textContent = "Stop Recording";
      isRecording = true;
    } else {
      mediaRecorder.stop();
      micCircle.classList.remove("animate-pulse");
      recordingStatus.classList.add("hidden");
      recordBtn.textContent = "Start Recording";
      isRecording = false;
    }
  });

  // ---------- Upload ----------
  uploadBtn.addEventListener("click", () => uploadInput.click());
  uploadInput.addEventListener("change", () => {
    const file = uploadInput.files[0];
    if (file) {
      const fileUrl = URL.createObjectURL(file);
      audioPlayer.src = fileUrl;
      audioPreview.classList.remove("hidden");
      audioName.textContent = file.name;

      const tempAudio = new Audio(fileUrl);
      tempAudio.onloadedmetadata = () => {
        const mins = Math.floor(tempAudio.duration / 60);
        const secs = Math.floor(tempAudio.duration % 60);
        audioDuration.textContent = `${mins}:${secs < 10 ? "0"+secs : secs}`;
      };
    }
  });

  // ---------- Analyze ----------
analyzeBtn.addEventListener("click", async () => {
  if (!audioBlob && uploadInput.files.length === 0) {
    alert("Please record or upload audio first!");
    return;
  }

  const file = audioBlob || uploadInput.files[0];
  const formData = new FormData();
  formData.append("file", file, "input.wav");

  resultsDiv.innerHTML = `<p class="text-gray-400 mt-4">⏳ Analyzing speech...</p>`;

  try {
    const res = await fetch("http://127.0.0.1:5000/analyze-speech", {
      method: "POST",
      body: formData
    });
    const data = await res.json();

    if (data.error) {
      resultsDiv.innerHTML = `<p class="text-red-400 mt-4">${data.error}</p>`;
      return;
    }

    // Dynamically assign colors
    const emotionColors = [
      "#3B82F6", "#FACC15", "#F87171", "#34D399", "#A78BFA", "#F472B6", "#FCD34D"
    ].slice(0, data.emotions.length);

    // Build list with matching dots
    let emotionListHtml = data.emotions
      .sort((a,b) => b.score - a.score)
      .map((e, index) => `
        <li class="text-sm flex items-center gap-2">
          <span class="w-3 h-3 rounded-full" style="background-color: ${emotionColors[index]};"></span>
          <span class="capitalize">${e.label}: <span class="font-medium">${(e.score*100).toFixed(2)}%</span></span>
        </li>
      `).join('');

    resultsDiv.innerHTML = `
      <p class="text-accent font-medium mt-2">Top Emotion: <span class="text-success">${data.top_emotion} (${(data.confidence*100).toFixed(2)}%)</span></p>
      <div class="flex flex-col md:flex-row items-center md:items-start gap-12 mt-4">
        <div class="w-full md:w-1/2 h-96">
          <canvas id="emotionChart"></canvas>
        </div>
        <div class="w-full md:w-1/2">
          <ul class="mt-20 space-y-2">
            ${emotionListHtml}
          </ul>
        </div>
      </div>
    `;

    // Render chart with same colors
    const ctx = document.getElementById("emotionChart").getContext("2d");
    const labels = data.emotions.map(e => e.label);
    const values = data.emotions.map(e => (e.score*100).toFixed(2));

    if (emotionChart) emotionChart.destroy();
    emotionChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: emotionColors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { display:false } }
      }
    });

  } catch (err) {
    console.error(err);
    resultsDiv.innerHTML = `<p class="text-red-400 mt-4">⚠ Error analyzing speech</p>`;
  }
});

</script>

</body>
</html>
